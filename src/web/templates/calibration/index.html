{% extends "base.html" %}

{% block title %}Kalibrierung - Floorball Vision{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">Kamera-Kalibrierung</h1>
        <a href="{{ url_for('calibration.lens_calibration') }}"
           class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 font-medium flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Lens-Kalibrierung (GoPro/Fisheye)
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Videos ohne Kalibrierung -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Videos kalibrieren</h2>

            {% if videos %}
            <div class="space-y-3">
                {% for video in videos %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-16 h-10 bg-gray-300 rounded overflow-hidden">
                            {% if video.file_path %}
                            <img src="/api/videos/{{ video.id }}/thumbnail"
                                 class="w-full h-full object-cover"
                                 onerror="this.style.display='none'">
                            {% endif %}
                        </div>
                        <div>
                            <p class="font-medium">{{ video.filename or video.original_filename }}</p>
                            <p class="text-sm text-gray-500">
                                {% if video.duration %}{{ "%.0f"|format(video.duration / 60) }} min{% endif %}
                                {% if video.width and video.height %} | {{ video.width }}x{{ video.height }}{% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <a href="{{ url_for('calibration.simple_calibration', video_id=video.id) }}"
                           class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 text-sm">
                            Einfach
                        </a>
                        <a href="{{ url_for('calibration.setup', video_id=video.id) }}"
                           class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm">
                            Erweitert
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500">
                <p>Keine Videos vorhanden.</p>
                <a href="/" class="text-blue-500 hover:underline">
                    Videos hochladen
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Bestehende Kalibrierungen -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Gespeicherte Kalibrierungen</h2>

            {% if calibrations %}
            <div class="space-y-3">
                {% for cal in calibrations %}
                <div class="p-3 bg-gray-50 rounded-lg {% if cal.is_active %}border-2 border-green-500{% endif %}">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium">{{ cal.name }}</p>
                            <p class="text-sm text-gray-500">
                                {{ cal.field_length }}m x {{ cal.field_width }}m |
                                {{ cal.created_at.strftime('%d.%m.%Y') if cal.created_at else 'Datum unbekannt' }}
                            </p>
                        </div>
                        <div class="flex items-center gap-2">
                            {% if cal.is_active %}
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Aktiv</span>
                            {% endif %}
                            <a href="{{ url_for('calibration.quick_calibration', video_id=cal.video_id) }}"
                               class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                Bearbeiten
                            </a>
                            <a href="{{ url_for('calibration.setup', video_id=cal.video_id) }}"
                               class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                                Setup
                            </a>
                            <button onclick="deleteCalibration('{{ cal.id }}')"
                                    class="text-red-500 hover:text-red-700 text-sm">
                                Löschen
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500">
                <p>Noch keine Kalibrierungen erstellt.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Info-Box -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="font-semibold text-blue-800 mb-3">Wie funktioniert die Kalibrierung?</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-700">
            <div>
                <p class="font-medium">1. Bande einzeichnen</p>
                <p>Zeichne das Spielfeld-Polygon um den Bereich zu definieren, in dem Spieler erkannt werden.</p>
            </div>
            <div>
                <p class="font-medium">2. Referenzpunkte setzen</p>
                <p>Markiere bekannte Punkte (Ecken, Mittellinie) im Video und auf dem Spielfeld-Template.</p>
            </div>
            <div>
                <p class="font-medium">3. Verifizieren</p>
                <p>Prüfe das Grid-Overlay um sicherzustellen, dass die Kalibrierung korrekt ist.</p>
            </div>
        </div>
    </div>
</div>

<script>
async function deleteCalibration(calId) {
    if (!confirm('Kalibrierung wirklich löschen?')) return;

    try {
        const response = await fetch(`/calibration/api/calibrations/${calId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            location.reload();
        } else {
            alert('Fehler: ' + result.error);
        }
    } catch (err) {
        alert('Fehler: ' + err.message);
    }
}
</script>
{% endblock %}
