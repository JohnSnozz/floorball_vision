{% extends "base.html" %}

{% block title %}Training - Floorball Vision{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">YOLO Training</h1>

    <!-- Aktives Modell -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Aktives Modell</h2>

        {% if active_model %}
        <div class="flex items-center justify-between">
            <div>
                <p class="text-lg font-medium text-green-600">{{ active_model.model_name }}</p>
                <p class="text-sm text-gray-500">mAP@50: {{ "%.2f"|format(active_model.map50 * 100) if active_model.map50 else "N/A" }}%</p>
                <p class="text-xs text-gray-400">{{ active_model.model_path }}</p>
            </div>
            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">Aktiv</span>
        </div>
        {% else %}
        <p class="text-gray-500">Kein Modell aktiv. Trainiere zuerst ein Modell und aktiviere es.</p>
        {% endif %}
    </div>

    <!-- Training Runs -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold mb-4">Training Runs</h2>

        {% if runs %}
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-2">Modell</th>
                        <th class="text-left py-2">Basis</th>
                        <th class="text-left py-2">Status</th>
                        <th class="text-left py-2">mAP@50</th>
                        <th class="text-left py-2">Dauer</th>
                        <th class="text-left py-2">Erstellt</th>
                        <th class="text-left py-2">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for run in runs %}
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3">{{ run.model_name }}</td>
                        <td class="py-3 text-sm text-gray-500">{{ run.base_model }}</td>
                        <td class="py-3">
                            {% if run.status == 'completed' %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">Fertig</span>
                            {% elif run.status == 'running' %}
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm animate-pulse">Läuft</span>
                            {% elif run.status == 'failed' %}
                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">Fehler</span>
                            {% else %}
                            <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">{{ run.status }}</span>
                            {% endif %}
                        </td>
                        <td class="py-3">
                            {{ "%.1f%%"|format(run.final_map50 * 100) if run.final_map50 else "-" }}
                        </td>
                        <td class="py-3 text-sm">
                            {% if run.training_time %}
                            {{ "%.0f min"|format(run.training_time / 60) }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="py-3 text-sm text-gray-500">
                            {{ run.created_at.strftime('%d.%m.%Y %H:%M') if run.created_at else '-' }}
                        </td>
                        <td class="py-3">
                            {% if run.status == 'completed' %}
                            <button onclick="activateModel('{{ run.id }}')"
                                    class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                Aktivieren
                            </button>
                            {% elif run.status == 'running' %}
                            <a href="{{ url_for('training.detail', run_id=run.id) }}"
                               class="text-blue-600 hover:underline text-sm">Details</a>
                            {% elif run.status == 'failed' %}
                            <span class="text-red-500 text-sm" title="{{ run.error_message }}">
                                Fehler anzeigen
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500">Noch keine Trainings durchgeführt.</p>
        <p class="text-sm text-gray-400 mt-2">
            Gehe zu <a href="{{ url_for('labeling.index') }}" class="text-blue-600 hover:underline">Labeling</a>,
            um ein Dataset zu erstellen und das Training zu starten.
        </p>
        {% endif %}
    </div>
</div>

<script>
async function activateModel(runId) {
    if (!confirm('Dieses Modell als aktives Modell setzen?')) return;

    try {
        const response = await fetch(`/training/api/activate/${runId}`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            alert(`Modell "${result.model_name}" aktiviert!`);
            location.reload();
        } else {
            alert('Fehler: ' + result.error);
        }
    } catch (err) {
        alert('Fehler: ' + err.message);
    }
}
</script>
{% endblock %}
